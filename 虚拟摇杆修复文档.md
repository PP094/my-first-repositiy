# 虚拟摇杆修复文档

## 问题描述
- 虚拟摇杆无法使用鼠标拖拽
- 虚拟摇杆头不在中心位置
- 虚拟摇杆位置太靠左，靠近墙壁

## 修复内容

### 1. `assets/scripts/ui/VirtualJoystick.gd`

#### 修改前
- 使用 `_unhandled_input` 函数处理输入事件
- 只处理触摸事件，不直接处理鼠标事件
- 没有设置 `mouse_filter` 属性，可能导致鼠标事件不被捕获

#### 修改后
- 改为使用 `_input` 函数处理输入事件，确保输入事件被正确捕获
- 直接处理鼠标事件，不依赖触摸模拟，这样在PC上也可以使用鼠标拖拽摇杆
- 在 `_ready` 函数中添加了 `mouse_filter = Control.MOUSE_FILTER_STOP`，确保Control节点可以接收鼠标事件
- 优化了坐标计算，确保摇杆头初始位置在摇杆基座的中心
- 改进了输入处理，使用全局坐标来计算触摸位置与摇杆基座的相对位置

### 2. `assets/scenes/TestScene.tscn` 和 `assets/scenes/MainScene.tscn`

#### 修改前
- 虚拟摇杆位置太靠左，靠近墙壁
- 摇杆基座和摇杆头是正方形

#### 修改后
- 调整了虚拟摇杆的位置，将 `anchor_left` 从 0.0 改为 0.1，使摇杆向右移动，远离墙壁
- 将摇杆基座和摇杆头改为圆形，通过设置 `corner_radius` 属性实现

## 技术细节

### 输入事件处理
- 使用 `_input` 函数代替 `_unhandled_input` 函数，确保输入事件被正确捕获
- 同时处理触摸事件和鼠标事件，确保在不同设备上都能正常工作
- 使用 `mouse_filter = Control.MOUSE_FILTER_STOP` 确保Control节点可以接收鼠标事件

### 坐标计算
- 摇杆基准位置计算：`base_position = base.position + base.size / 2 - stick.size / 2`，确保摇杆头初始位置在摇杆基座的中心
- 触摸位置计算：使用全局坐标 `base.get_global_position() + base.size / 2` 作为摇杆基座的中心位置，确保触摸位置与摇杆基座的相对位置计算正确
- 摇杆头移动范围限制：使用 `min(direction.length(), stick_radius)` 限制摇杆头的移动范围，确保摇杆头不会超出摇杆基座

### 输入管理器集成
- 使用动态路径获取InputManager节点，确保输入管理器的引用正确
- 在输入事件处理中更新输入管理器的状态，确保角色可以正确响应输入

## 测试方法

1. 打开 `minimal_joystick_test.tscn` 场景
2. 运行场景，使用鼠标点击并拖拽摇杆头，观察摇杆头是否会跟随鼠标移动
3. 检查角色是否会根据摇杆的输入移动

## 结论

通过以上修改，虚拟摇杆现在可以正常工作，支持鼠标拖拽，摇杆头初始位置在中心，位置也调整到了合适的位置。这些修改确保了虚拟摇杆在不同设备上都能正常工作，提升了游戏的用户体验。